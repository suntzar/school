<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Alunos para Impressão</title>
    <link rel="icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IS0tIFVwbG9hZGVkIHRvOiBTVkcgUmVwbywgd3d3LnN2Z3JlcG8uY29tLCBHZW5lcmF0b3I6IFNWRyBSZXBvIE1peGVyIFRvb2xzIC0tPg0KPHN2ZyB3aWR0aD0iODAwcHgiIGhlaWdodD0iODAwcHgiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCjxwYXRoIGQ9Ik0yMyA3LjkzOTk0VjI5LjM5OTlIOVY3LjkzOTk0QzguOTk4OTYgNy42MDk3NCA5LjA3OTY5IDcuMjg0NDIgOS4yMzQ5OSA2Ljk5MzAyQzkuMzkwMjkgNi43MDE2MSA5LjYxNTMyIDYuNDUzMiA5Ljg5IDYuMjY5OTRMMTQuODkgMi45Mzk5NEMxNS4yMTg3IDIuNzIwNjYgMTUuNjA0OSAyLjYwMzY0IDE2IDIuNjAzNjRDMTYuMzk1MSAyLjYwMzY0IDE2Ljc4MTMgMi43MjA2NiAxNy4xMSAyLjkzOTk0TDIyLjExIDYuMjY5OTRDMjIuMzg0NyA2LjQ1MzIgMjIuNjA5NyA2LjcwMTYxIDIyLjc2NSA2Ljk5MzAyQzIyLjkyMDMgNy4yODQ0MiAyMy4wMDEgNy42MDk3NCAyMyA3LjkzOTk0WiIgZmlsbD0iIzJFN0QzMiIvPg0KPHBhdGggZD0iTTI3IDE1LjRIMjNWMjkuNEgyN0MyNy43OTU2IDI5LjQgMjguNTU4NyAyOS4wODQgMjkuMTIxMyAyOC41MjEzQzI5LjY4MzkgMjcuOTU4NyAzMCAyNy4xOTU3IDMwIDI2LjRWMTguNEMzMCAxNy42MDQ0IDI5LjY4MzkgMTYuODQxMyAyOS4xMjEzIDE2LjI3ODdDMjguNTU4NyAxNS43MTYxIDI3Ljc5NTYgMTUuNCAyNyAxNS40WiIgZmlsbD0iI0ZGNkYwMCIvPg0KPHBhdGggZD0iTTE4IDE3LjRIMTRDMTMuNzM0OCAxNy40IDEzLjQ4MDQgMTcuNTA1NCAxMy4yOTI5IDE3LjY5MjlDMTMuMTA1NCAxNy44ODA1IDEzIDE4LjEzNDggMTMgMTguNFYyOS40SDE1VjE5LjRIMTdWMjkuNEgxOVYxOC40QzE5IDE4LjEzNDggMTguODk0NiAxNy44ODA1IDE4LjcwNzEgMTcuNjkyOUMxOC41MTk2IDE3LjUwNTQgMTguMjY1MiAxNy40IDE4IDE3LjRaIiBmaWxsPSIjMjYzMjM4Ii8+DQo8cGF0aCBkPSJNMTggMTAuNEgxNEMxMy43MzQ4IDEwLjQgMTMuNDgwNCAxMC4yOTQ3IDEzLjI5MjkgMTAuMTA3MUMxMy4xMDU0IDkuOTE5NiAxMyA5LjY2NTI0IDEzIDkuNDAwMDJDMTMgOS4xMzQ4MSAxMy4xMDU0IDguODgwNDUgMTMuMjkyOSA4LjY5MjkyQzEzLjQ4MDQgOC41MDUzOCAxMy43MzQ4IDguNDAwMDIgMTQgOC40MDAwMkgxOEMxOC4yNjUyIDguNDAwMDIgMTguNTE5NiA4LjUwNTM4IDE4LjcwNzEgOC42OTI5MkMxOC44OTQ2IDguODgwNDUgMTkgOS4xMzQ4MSAxOSA5LjQwMDAyQzE5IDkuNjY1MjQgMTguODk0NiA5LjkxOTYgMTguNzA3MSAxMC4xMDcxQzE4LjUxOTYgMTAuMjk0NyAxOC4yNjUyIDEwLjQgMTggMTAuNFoiIGZpbGw9IiNGNUY1RjUiLz4NCjxwYXRoIGQ9Ik0xOCAxNC40SDE0QzEzLjczNDggMTQuNCAxMy40ODA0IDE0LjI5NDcgMTMuMjkyOSAxNC4xMDcxQzEzLjEwNTQgMTMuOTE5NiAxMyAxMy42NjUyIDEzIDEzLjRDMTMgMTMuMTM0OCAxMy4xMDU0IDEyLjg4MDUgMTMuMjkyOSAxMi42OTI5QzEzLjQ4MDQgMTIuNTA1NCAxMy43MzQ4IDEyLjQgMTQgMTIuNEgxOEMxOC4yNjUyIDEyLjQgMTguNTE5NiAxMi41MDU0IDE4LjcwNzEgMTIuNjkyOUMxOC44OTQ2IDEyLjg4MDUgMTkgMTMuMTM0OCAxOSAxMy40QzE5IDEzLjY2NTIgMTguODk0NiAxMy45MTk2IDE4LjcwNzEgMTQuMTA3MUMxOC41MTk2IDE0LjI5NDcgMTguMjY1MiAxNC40IDE4IDE0LjRaIiBmaWxsPSIjRjVGNUY1Ii8+DQo8cGF0aCBkPSJNMTQuOSAyLjkzOTk4TDkuOSA2LjI2OTk4QzkuNjIzNDcgNi40NTIwOSA5LjM5NjQ4IDYuNyA5LjIzOTQgNi45OTE0OEM5LjA4MjMxIDcuMjgyOTUgOS4wMDAwNSA3LjYwODg3IDkgNy45Mzk5OFYyOS40SDE2VjIuNTk5OThDMTUuNjA3OSAyLjYwMzA0IDE1LjIyNTQgMi43MjEyNyAxNC45IDIuOTM5OThaIiBmaWxsPSIjMzg4RTNDIi8+DQo8cGF0aCBkPSJNMTQgMTcuNEMxMy43MzQ4IDE3LjQgMTMuNDgwNCAxNy41MDU0IDEzLjI5MjkgMTcuNjkyOUMxMy4xMDU0IDE3Ljg4MDUgMTMgMTguMTM0OCAxMyAxOC40VjI5LjRIMTVWMTkuNEgxNlYxNy40SDE0WiIgZmlsbD0iIzM3NDc0RiIvPg0KPHBhdGggZD0iTTE0IDguNDAwMDJDMTMuNzM0OCA4LjQwMDAyIDEzLjQ4MDQgOC41MDUzOCAxMy4yOTI5IDguNjkyOTJDMTMuMTA1NCA4Ljg4MDQ1IDEzIDkuMTM0ODEgMTMgOS40MDAwMkMxMyA5LjY2NTI0IDEzLjEwNTQgOS45MTk2IDEzLjI5MjkgMTAuMTA3MUMxMy40ODA0IDEwLjI5NDcgMTMuNzM0OCAxMC40IDE0IDEwLjRIMTZWOC40MDAwMkgxNFoiIGZpbGw9IiNGNUY1RjUiLz4NCjxwYXRoIGQ9Ik0xNCAxMi40QzEzLjczNDggMTIuNCAxMy40ODA0IDEyLjUwNTQgMTMuMjkyOSAxMi42OTI5QzEzLjEwNTQgMTIuODgwNSAxMyAxMy4xMzQ4IDEzIDEzLjRDMTMgMTMuNjY1MiAxMy4xMDU0IDEzLjkxOTYgMTMuMjkyOSAxNC4xMDcxQzEzLjQ4MDQgMTQuMjk0NyAxMy43MzQ4IDE0LjQgMTQgMTQuNEgxNlYxMi40SDE0WiIgZmlsbD0iI0Y1RjVGNSIvPg0KPHBhdGggZD0iTTUgMTUuNEM0LjIwNDM1IDE1LjQgMy40NDEyOSAxNS43MTYxIDIuODc4NjggMTYuMjc4N0MyLjMxNjA3IDE2Ljg0MTMgMiAxNy42MDQ0IDIgMTguNFYyNi40QzIgMjcuMTk1NyAyLjMxNjA3IDI3Ljk1ODcgMi44Nzg2OCAyOC41MjEzQzMuNDQxMjkgMjkuMDg0IDQuMjA0MzUgMjkuNCA1IDI5LjRIOVYxNS40SDVaIiBmaWxsPSIjRjlBODI1Ii8+DQo8L3N2Zz4=">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Gerais e para a Tela */
        body {
            font-family: "Roboto Mono", monospace;
            background-color: #e9ecef;
            color: #212529;
            margin: 0;
            font-size: 9pt;
        }

        .page-container {
            width: 190mm; 
            min-height: 277mm; 
            margin: 20px auto;
            padding: 10mm;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .controls {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        #placeholder {
            text-align: center;
            color: #6c757d;
            margin-top: 50px;
            font-style: italic;
        }

        /* Estrutura do Documento */
        .doc-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1.5px solid #000;
        }
        .doc-header h1 { font-size: 14pt; margin: 0; font-weight: bold; }
        .doc-header p { font-size: 11pt; margin: 0; }

        .turma-title {
            text-align: center;
            font-size: 12pt;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            text-transform: uppercase;
        }

        /* Tabela Otimizada para Impressão */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #333;
            padding: 6px;
            text-align: left;
            vertical-align: top;
        }

        thead th {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        
        td p {
            margin: 0;
            padding: 2px 0;
        }
        
        .student-name-main {
            font-weight: 600;
        }
        
        .field-label {
            font-weight: 600;
            color: #444;
            margin-right: 5px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 7pt;
            font-weight: bold;
            color: #fff;
            margin-left: 8px;
            text-transform: uppercase;
            vertical-align: middle;
            -webkit-print-color-adjust: exact; /* FORÇA A IMPRESSÃO DA COR */
            print-color-adjust: exact;      /* VERSÃO PADRÃO */
        }
        .status-ativo { background-color: #198754 !important; }
        .status-transferido { background-color: #ffc107 !important; color: #000 !important; }
        .status-inativo { background-color: #6c757d !important; }

        .col-numero { width: 4%; text-align: center; }
        .col-aluno { width: 30%; }
        .col-dados { width: 16%; }
        .col-filiacao { width: 22%; }
        .col-contato { width: 28%; }

        @media print {
            body { background-color: #fff; }
            .controls, .page-container { box-shadow: none; }
            .controls { display: none; }
            .page-container {
                width: auto;
                min-height: 0;
                margin: 0;
                padding: 0;
            }
            thead {
                background-color: #f2f2f2 !important; /* Garante que o fundo do header também imprima */
            }
            tbody tr:nth-child(even) {
                background-color: #f8f8f8 !important; /* Força impressão das linhas zebradas */
            }
            tr, .turma-title { page-break-inside: avoid; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <button onclick="window.print()">Imprimir Lista</button>
        <p style="font-family: sans-serif; font-size: small; color: #6c757d; margin-top: 10px;">Use a função de impressão do navegador (Ctrl+P ou Cmd+P).</p>
    </div>

    <div class="page-container">
        <div id="print-area">
            <p id="placeholder">A lista de alunos aparecerá aqui.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const dataUrl = params.get('data');

            if (dataUrl) {
                fetch(decodeURIComponent(dataUrl))
                    .then(response => response.json())
                    .then(students => {
                        renderListForPrint(students);
                        // Clean up the blob URL
                        URL.revokeObjectURL(decodeURIComponent(dataUrl));
                    })
                    .catch(error => {
                        document.getElementById('print-area').innerHTML = `<p id="placeholder">Erro ao carregar os dados dos alunos.</p>`;
                        console.error("Erro ao carregar dados da URL:", error);
                    });
            } else {
                 document.getElementById('print-area').innerHTML = `<p id="placeholder">Nenhum dado de aluno encontrado.</p>`;
            }
        });

        function getStatusBadge(status) {
            status = status || 'Ativo';
            const statusColors = {
                'Ativo': 'status-ativo',
                'Transferido': 'status-transferido',
                'Inativo': 'status-inativo',
            };
            const colorClass = statusColors[status] || 'status-inativo';
            return `<span class="status-badge ${colorClass}">${status}</span>`;
        }

        function renderListForPrint(students) {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';

            const docHeader = document.createElement('div');
            docHeader.className = 'doc-header';
            docHeader.innerHTML = `<h1>E. M. ANA MARIA CORDEIRO DE SOUSA</h1><p>LISTA DE ALUNOS</p>`;
            printArea.appendChild(docHeader);

            const groupedByTurma = students.reduce((acc, student) => {
                (acc[student.turma] = acc[student.turma] || []).push(student);
                return acc;
            }, {});

            const sortedTurmas = Object.keys(groupedByTurma).sort();

            sortedTurmas.forEach((turma, turmaIndex) => {
                const turmaContainer = document.createElement('div');
                if (turmaIndex > 0) {
                    turmaContainer.className = 'page-break';
                }
                
                const turno = groupedByTurma[turma][0]?.turno || '';
                turmaContainer.innerHTML = `<h2 class="turma-title">TURMA: ${turma} – ${turno}</h2>`;

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="col-numero">N°</th>
                            <th class="col-aluno">Aluno / Status</th>
                            <th class="col-dados">Dados Pessoais</th>
                            <th class="col-filiacao">Filiação</th>
                            <th class="col-contato">Contato</th>
                        </tr>
                    </thead>
                `;
                const tbody = document.createElement('tbody');
                
                groupedByTurma[turma].sort((a, b) => a.nome.localeCompare(b.nome));

                groupedByTurma[turma].forEach((student, index) => {
                    const row = document.createElement('tr');
                    const safeText = (text) => text || '---';

                    row.innerHTML = `
                        <td class="col-numero">${index + 1}</td>
                        <td class="col-aluno">
                            <span class="student-name-main">${safeText(student.nome)}</span>
                            ${getStatusBadge(student.status)}
                        </td>
                        <td class="col-dados">
                            <p><span class="field-label">Nasc:</span>${safeText(student.nascimento)}</p>
                            <p><span class="field-label">Cor:</span>${safeText(student.cor)}</p>
                        </td>
                        <td class="col-filiacao">
                            <p><span class="field-label">Mãe:</span>${safeText(student.mae)}</p>
                            <p><span class="field-label">Pai:</span>${safeText(student.pai)}</p>
                        </td>
                        <td class="col-contato">
                            <p><span class="field-label">Tel:</span>${student.telefone && student.telefone.length ? student.telefone.join(', ') : '---'}</p>
                            <p><span class="field-label">End:</span>${safeText(student.endereco)}</p>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                turmaContainer.appendChild(table);
                printArea.appendChild(turmaContainer);
            });
        }
    </script>
</body>
</html>