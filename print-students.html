<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Alunos para Impressão</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1IiBmaWxsPSIjNGY0NmU1Ii8+PHBhdGggZD0iTTY4LjUgMjUuNWwtMzQgMzQtNiAxMiAxMi02IDM0LTM0YzItMiAyLTUgMC03bC02LTZjLTItMi01LTItNyAwek0zMS41IDYyLjVsOSA5IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjciIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Gerais e para a Tela */
        body {
            font-family: "Roboto Mono", monospace;
            background-color: #e9ecef;
            color: #212529;
            margin: 0;
            font-size: 9pt;
        }

        .page-container {
            width: 190mm; 
            min-height: 277mm; 
            margin: 20px auto;
            padding: 10mm;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .controls {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        #placeholder {
            text-align: center;
            color: #6c757d;
            margin-top: 50px;
            font-style: italic;
        }

        /* Estrutura do Documento */
        .doc-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1.5px solid #000;
        }
        .doc-header h1 { font-size: 14pt; margin: 0; font-weight: bold; }
        .doc-header p { font-size: 11pt; margin: 0; }

        .turma-title {
            text-align: center;
            font-size: 12pt;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            text-transform: uppercase;
        }

        /* Tabela Otimizada para Impressão */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #333;
            padding: 6px;
            text-align: left;
            vertical-align: top;
        }

        thead th {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        
        td p {
            margin: 0;
            padding: 2px 0;
        }
        
        .student-name-main {
            font-weight: 600;
        }
        
        .field-label {
            font-weight: 600;
            color: #444;
            margin-right: 5px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 7pt;
            font-weight: bold;
            color: #fff;
            margin-left: 8px;
            text-transform: uppercase;
            vertical-align: middle;
            -webkit-print-color-adjust: exact; /* FORÇA A IMPRESSÃO DA COR */
            print-color-adjust: exact;      /* VERSÃO PADRÃO */
        }
        .status-ativo { background-color: #198754 !important; }
        .status-transferido { background-color: #ffc107 !important; color: #000 !important; }
        .status-inativo { background-color: #6c757d !important; }

        .col-numero { width: 4%; text-align: center; }
        .col-aluno { width: 30%; }
        .col-dados { width: 16%; }
        .col-filiacao { width: 22%; }
        .col-contato { width: 28%; }

        @media print {
            body { background-color: #fff; }
            .controls, .page-container { box-shadow: none; }
            .controls { display: none; }
            .page-container {
                width: auto;
                min-height: 0;
                margin: 0;
                padding: 0;
            }
            thead {
                background-color: #f2f2f2 !important; /* Garante que o fundo do header também imprima */
            }
            tbody tr:nth-child(even) {
                background-color: #f8f8f8 !important; /* Força impressão das linhas zebradas */
            }
            tr, .turma-title { page-break-inside: avoid; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <button onclick="window.print()">Imprimir Lista</button>
        <p style="font-family: sans-serif; font-size: small; color: #6c757d; margin-top: 10px;">Use a função de impressão do navegador (Ctrl+P ou Cmd+P).</p>
    </div>

    <div class="page-container">
        <div id="print-area">
            <p id="placeholder">A lista de alunos aparecerá aqui.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const dataUrl = params.get('data');

            if (dataUrl) {
                fetch(decodeURIComponent(dataUrl))
                    .then(response => response.json())
                    .then(students => {
                        renderListForPrint(students);
                        // Clean up the blob URL
                        URL.revokeObjectURL(decodeURIComponent(dataUrl));
                    })
                    .catch(error => {
                        document.getElementById('print-area').innerHTML = `<p id="placeholder">Erro ao carregar os dados dos alunos.</p>`;
                        console.error("Erro ao carregar dados da URL:", error);
                    });
            } else {
                 document.getElementById('print-area').innerHTML = `<p id="placeholder">Nenhum dado de aluno encontrado.</p>`;
            }
        });

        function getStatusBadge(status) {
            status = status || 'Ativo';
            const statusColors = {
                'Ativo': 'status-ativo',
                'Transferido': 'status-transferido',
                'Inativo': 'status-inativo',
            };
            const colorClass = statusColors[status] || 'status-inativo';
            return `<span class="status-badge ${colorClass}">${status}</span>`;
        }

        function renderListForPrint(students) {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';

            const docHeader = document.createElement('div');
            docHeader.className = 'doc-header';
            docHeader.innerHTML = `<h1>E. M. ANA MARIA CORDEIRO DE SOUSA</h1><p>LISTA DE ALUNOS</p>`;
            printArea.appendChild(docHeader);

            const groupedData = students.reduce((acc, student) => {
                const groupKey = `${student.turma || 'Sem Turma'} - ${student.turno || 'Sem Turno'}`;
                if (!acc[groupKey]) {
                    acc[groupKey] = [];
                }
                acc[groupKey].push(student);
                return acc;
            }, {});

            const customOrder = ['CRECHE III', 'INFANTIL I', 'INFANTIL II', '1º ANO'];
            const sortedGroupKeys = Object.keys(groupedData).sort((a, b) => {
                const turmaA = a.split(' - ')[0];
                const turmaB = b.split(' - ')[0];

                const indexA = customOrder.indexOf(turmaA);
                const indexB = customOrder.indexOf(turmaB);

                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                if (indexA !== indexB) return indexA - indexB;

                return a.localeCompare(b);
            });

            sortedGroupKeys.forEach((groupKey, groupIndex) => {
                const turmaContainer = document.createElement('div');
                if (groupIndex > 0) {
                    turmaContainer.className = 'page-break';
                }
                
                turmaContainer.innerHTML = `<h2 class="turma-title">TURMA: ${groupKey}</h2>`;

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="col-numero">N°</th>
                            <th class="col-aluno">Aluno / Status</th>
                            <th class="col-dados">Dados Pessoais</th>
                            <th class="col-filiacao">Filiação</th>
                            <th class="col-contato">Contato</th>
                        </tr>
                    </thead>
                `;
                const tbody = document.createElement('tbody');
                
                const studentsInGroup = groupedData[groupKey];
                
                // New sorting logic for status
                studentsInGroup.sort((a, b) => {
                    const statusOrder = {
                        'Ativo': 1,
                        '': 1, // Undefined or empty status as 'Ativo'
                        undefined: 1, // Undefined or empty status as 'Ativo'
                        'Inativo': 2,
                        'Transferido': 3
                    };

                    const statusA = statusOrder[a.status] || statusOrder['']; // Handle undefined/empty
                    const statusB = statusOrder[b.status] || statusOrder['']; // Handle undefined/empty

                    if (statusA !== statusB) {
                        return statusA - statusB;
                    }
                    
                    // If statuses are the same, sort by name
                    return a.nome.localeCompare(b.nome);
                });

                studentsInGroup.forEach((student, index) => {
                    const row = document.createElement('tr');
                    const safeText = (text) => text || '---';

                    row.innerHTML = `
                        <td class="col-numero">${index + 1}</td>
                        <td class="col-aluno">
                            <span class="student-name-main">${safeText(student.nome)}</span>
                            ${getStatusBadge(student.status)}
                        </td>
                        <td class="col-dados">
                            <p><span class="field-label">Nasc:</span>${safeText(student.nascimento)}</p>
                            <p><span class="field-label">Cor:</span>${safeText(student.cor)}</p>
                        </td>
                        <td class="col-filiacao">
                            <p><span class="field-label">Mãe:</span>${safeText(student.mae)}</p>
                            <p><span class="field-label">Pai:</span>${safeText(student.pai)}</p>
                        </td>
                        <td class="col-contato">
                            <p><span class="field-label">Tel:</span>${student.telefone && student.telefone.length ? student.telefone.join(', ') : '---'}</p>
                            <p><span class="field-label">End:</span>${safeText(student.endereco)}</p>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                turmaContainer.appendChild(table);
                printArea.appendChild(turmaContainer);
            });
        }
    </script>
</body>
</html>